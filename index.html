<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privados - Auxilio Legal</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a237e">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --primary: #1a237e; --secondary: #c62828; --accent: #25D366; --bg: #f0f2f5; --white: #ffffff; --purple: #9c27b0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 20px; }
        header { background: var(--primary); color: var(--white); padding: 25px 15px; text-align: center; border-radius: 0 0 25px 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        header h1 { margin: 0; font-size: 1.8em; letter-spacing: 2px; }
        header p { font-size: 0.85em; margin-top: 10px; line-height: 1.4; opacity: 0.9; }
        .container { padding: 15px; }
        .view { display: none; animation: fadeIn 0.4s; }
        .active-view { display: block; }
        .hook-card { background: linear-gradient(135deg, #1a237e, #3949ab); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; }
        .btn-private { background: var(--accent); color: white; padding: 12px; border-radius: 8px; text-decoration: none; display: block; font-weight: bold; margin-top: 12px; border: none; width: 100%; }
        .nav-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .nav-item { background: var(--white); padding: 20px; border-radius: 15px; text-align: center; font-weight: bold; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }
        .academia-header { background: #fff; border: 1px solid #e1bee7; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        .search-box input { width: 93%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-top: 10px; }
        .card-juridica { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border-left: 5px solid var(--purple); }
        .tag-tutorial { background: #673ab7; color: white; padding: 3px 8px; border-radius: 5px; font-size: 0.7em; font-weight: bold; }
        .author-info { font-size: 0.75em; color: #666; margin: 10px 0; }
        .card-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 15px; }
        .btn-action { border: none; padding: 8px; border-radius: 5px; color: white; font-size: 0.65em; font-weight: bold; }
        .chat-container { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .msg { margin-bottom: 8px; padding: 8px; background: #f1f3f9; border-radius: 8px; font-size: 0.9em; }
        #admin-panel { display: none; background: #fff3cd; padding: 15px; border-radius: 15px; border: 2px dashed #ffeeba; margin-top: 20px; }
        .admin-input { width: 92%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<header id="main-header">
    <h1>PRIVADOS</h1>
    <p>Orientaci√≥n jur√≠dica gratuita para familiares de detenidos en T√°chira.</p>
</header>

<div class="container">
    <div id="view-home" class="view active-view">
        <div class="chat-container">
            <h4 style="margin:0; color: var(--secondary)">üí¨ Chat P√∫blico de Apoyo</h4>
            <div id="public-messages" style="height: 150px; overflow-y: auto; border-bottom: 1px solid #eee; margin-bottom: 10px;"></div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="chat-input" style="flex:1; padding:10px;" placeholder="Escribe tu duda...">
                <button onclick="enviarMensajePublico()" style="background:var(--primary); color:white; border:none; padding:10px; border-radius:5px;">Enviar</button>
            </div>
        </div>

        <div class="hook-card">
            <h3>¬øConsulta Privada y Gratuita?</h3>
            <p>Obtenga una segunda opini√≥n confidencial sobre su caso.</p>
            <button onclick="showView('view-chat-privado')" class="btn-private">SOLICITAR SEGUNDA OPINI√ìN</button>
        </div>

        <div class="nav-grid">
            <div class="nav-item" onclick="showView('view-org')">üèõÔ∏è Organismos</div>
            <div class="nav-item" onclick="showView('view-proceso')">‚öñÔ∏è Academia</div>
            <div class="nav-item" onclick="showView('view-videos')">üé• Videos</div>
            <div class="nav-item" onclick="showView('view-home')">üè† Inicio</div>
        </div>
    </div>

    <div id="view-proceso" class="view">
        <button onclick="showView('view-home')" style="margin-bottom:15px;">‚Üê Volver</button>
        <div class="academia-header">
            <h3 style="margin:0; color:var(--purple);">üí° ACADEMIA Y GU√çA</h3>
            <div class="search-box">
                <input type="text" id="busqueda" onkeyup="filtrar()" placeholder="üîç Buscar tema...">
            </div>
        </div>
        <div id="lista-proceso-dinamica"></div>
    </div>

    <div id="view-org" class="view">
        <button onclick="showView('view-home')" style="margin-bottom:15px;">‚Üê Volver</button>
        <h2>Sistema de Justicia</h2>
        <div id="lista-organismos"></div>
    </div>

    <div id="view-videos" class="view">
        <button onclick="showView('view-home')" style="margin-bottom:15px;">‚Üê Volver</button>
        <h2>Videos Gu√≠a</h2>
        <div class="card-juridica">Contenido multimedia en proceso...</div>
    </div>

    <div id="admin-panel">
        <h3>Panel Administrador</h3>
        <input type="text" id="adm-proc-tit" class="admin-input" placeholder="T√≠tulo de la Fase">
        <textarea id="adm-proc-txt" class="admin-input" placeholder="Explicaci√≥n jur√≠dica..."></textarea>
        <button onclick="guardarProc()" style="width:100%; background:var(--purple); color:white; padding:10px; border:none; border-radius:5px;">Publicar en Academia</button>
        <hr>
        <input type="text" id="adm-org-nom" class="admin-input" placeholder="Organismo">
        <input type="text" id="adm-org-tel" class="admin-input" placeholder="Tel√©fono/Direcci√≥n">
        <button onclick="guardarOrg()" style="width:100%; background:var(--primary); color:white; padding:10px; border:none; border-radius:5px;">Guardar Organismo</button>
        <hr>
        <h4 style="margin-bottom:5px; color:#00796b;">üë• Registrar Colegas al Equipo</h4>
        <input type="text" id="adm-abg-pin" class="admin-input" placeholder="Crear PIN (ej. 5678)">
        <input type="text" id="adm-abg-nom" class="admin-input" placeholder="Nombre (ej. Dra. Ana Silva)">
        <input type="text" id="adm-abg-tel" class="admin-input" placeholder="WhatsApp (ej. 584140000000 sin el +)">
        <button onclick="guardarAbogado()" style="width:100%; background:#00796b; color:white; padding:10px; border:none; border-radius:5px;">A√±adir Abogado al Equipo</button>
        
        <div id="seccion-alertas" style="margin-top:20px; background:#f8d7da; padding:10px; border-radius:10px;">
            <h4 style="margin:0; color:#721c24;">üö® ALERTAS EN VIVO</h4>
            <div id="panel-emergencias-admin" style="display:none; background: #fff; border: 2px solid #c62828; border-radius: 12px; padding: 15px; margin: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
    <h3 style="color: #c62828; margin-top: 0; display: flex; align-items: center; gap: 10px;">
        üö® <span id="contador-pendientes">0</span> CONSULTAS PENDIENTES
    </h3>
    <div id="lista-prioritaria" style="max-height: 200px; overflow-y: auto;">
        </div>
</div>

        </div>
        <button onclick="this.parentElement.style.display='none'" style="width:100%; margin-top:10px; color:red; border:none; background:none;">Cerrar Panel</button>
    </div>

    <div id="view-chat-privado" class="view">
        <button onclick="showView('view-home')" style="margin-bottom:15px;">‚Üê Volver</button>
        <div class="chat-container" style="border-top: 5px solid var(--accent);">
            <h4 style="margin:0; color: var(--primary)">üîí Consultor√≠a Privada</h4>
            <div id="registro-consulta">
                <input type="text" id="priv-nombre" class="admin-input" placeholder="Nombre completo">
               <select id="priv-motivo" class="admin-input">
    <option value="">¬øMotivo de la consulta?</option>
    <option value="Familiar reci√©n detenido">Tengo un familiar reci√©n detenido</option>
    <option value="Familiar detenido hace tiempo">Tengo un familiar detenido hace tiempo</option>
    <option value="Situaci√≥n jur√≠dica">Quiero conocer situaci√≥n jur√≠dica</option>
    <option value="Dejar sin efecto captura">Quiero dejar sin efecto una captura</option>
    <option value="Tramitar redenciones">Quiero tramitar redenciones de pena</option>
    <option value="Acceder a beneficio">Quiero acceder a un beneficio</option>
    <option value="Antecedentes penales">Quiero tramitar antecedentes penales</option>
    <option value="No presentaci√≥n UTSO/CRS">No me he presentado en tribunales ni en la UTSO ni en el CRS</option>
    <option value="Necesito abogado audiencia">Necesito un abogado para una audiencia de presentaci√≥n, preliminar o juicio</option>
    <option value="Informaci√≥n de familiar">Necesito informaci√≥n sobre un familiar detenido</option>
    <option value="Otros motivos">Otros motivos</option>
</select>

                <button onclick="iniciarConsulta()" class="btn-private" style="margin-top:0;">INICIAR CHAT</button>
                <div style="margin-top: 20px; background: #f8f9fa; border-left: 4px solid #1a237e; padding: 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
    <p style="margin: 0 0 8px 0; color: #1a237e; font-size: 0.9em; font-weight: bold; display: flex; align-items: center; gap: 5px;">
        üîí Garant√≠a de Confidencialidad Absoluta
    </p>
    <p style="margin: 0; color: #555; font-size: 0.8em; line-height: 1.5; text-align: justify;">
        Al iniciar, entrar√° a un canal completamente confidencial. En estricto cumplimiento del <b>Secreto Profesional</b>, al cerrar la sesi√≥n toda la conversaci√≥n, audios, im√°genes y documentos se <b>destruir√°n autom√°ticamente</b> de la base de datos y de su celular, sin dejar rastro alguno.
    </p>
</div>

            </div>

            <div id="interfaz-chat-privado" style="display:none;">
<div id="private-messages" style="height: 300px; overflow-y: auto; border-bottom: 1px solid #eee; margin-bottom: 10px; padding: 5px; position: relative;">
  
</div>
<div style="display: flex; flex-direction: column; gap: 10px;">
    <textarea id="priv-input" style="width: 95%; height: 80px; padding: 10px; border-radius: 8px; border: 1px solid #ccc;" placeholder="Escriba su mensaje confidencial aqu√≠..."></textarea>
    
    <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px;">
        <input type="file" id="priv-file-upload" style="display: none;" onchange="procesarArchivoPrivado(event)">
        <label for="priv-file-upload" style="background: #e0e0e0; padding: 10px; border-radius: 8px; cursor: pointer; flex: 0.5; text-align: center;">üìé</label>
        <button id="btn-mic-privado" style="background: #e0e0e0; border: none; padding: 10px; border-radius: 8px; flex: 0.5; cursor: pointer;" onclick="toggleMicPrivado()">üé§</button>
        <button onclick="enviarMensajeTextoPrivado()" style="background: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; flex: 2; font-weight: bold;">ENVIAR MENSAJE</button>
    </div>
</div>

<div id="info-abogado-asignado" style="margin-top: 10px;">
    <p id="titulo-abogado" style="font-size: 0.9em; text-align: center; color: #555;"></p>
    <a id="btn-salto-wa" href="javascript:void(0)" onclick="if(this.href.includes('javascript')) alert('Esperando a que un abogado acepte su caso para habilitar WhatsApp...')" target="_blank" style="text-decoration: none;">
        <button style="background: #ccc; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
            ‚åõ ESPERANDO ASIGNACI√ìN...
        </button>
    </a>
</div>
</div>

        </div>
    </div>
</div>

<script>
// 1. GESTI√ìN DE CACH√â Y SERVICE WORKER
if ('caches' in window) { 
    caches.keys().then(names => { names.forEach(name => { caches.delete(name); }); }); 
}
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(error => { console.log('SW fall√≥:', error); });
    });
}

// 2. CONFIGURACI√ìN FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyB_mCIiDNydYbspCYOEiBiXlOF3og_Va70",
    authDomain: "privadosayuda-f01f1.firebaseapp.com",
    databaseURL: "https://privadosayuda-f01f1-default-rtdb.firebaseio.com/",
    projectId: "privadosayuda-f01f1",
    storageBucket: "privadosayuda-f01f1.firebasestorage.app",
    messagingSenderId: "137166482903",
    appId: "1:137166482903:web:1221fa92f4ed9fa5902f92"
};

if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
const db = firebase.database();
firebase.auth().signInAnonymously();

// 3. VARIABLES DE ESTADO GLOBAL
let esAdmin = false;
let nombreAdmin = "";
let telefonoAdmin = "";
let consultaActualId = null;
let listenerPrivado = null;
let mediaRecorder;
let audioChunks = [];
let grabando = false;
const alarmaAdmin = new Audio('https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3');
alarmaAdmin.loop = true;

// 4. NAVEGACI√ìN (La funci√≥n showView que usan tus botones)
function showView(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
    document.getElementById(id).classList.add('active-view');
    window.scrollTo(0,0);
}

// 5. SISTEMA MULTI-ADMINISTRADOR
let t = 0;
let equipoLegalDinamico = {};

// Recuperar sesi√≥n si ya exist√≠a (Persistencia b√°sica)
const adminGuardado = localStorage.getItem('admin_activo');
if(adminGuardado) {
    const datos = JSON.parse(adminGuardado);
    esAdmin = true;
    nombreAdmin = datos.nombre;
    telefonoAdmin = datos.telefono;
    document.getElementById('admin-panel').style.display = 'block';
    // ESTO ES LO M√ÅS IMPORTANTE: Reactivar el motor siempre
    setTimeout(activarMotorAdmin, 2000); 
}

db.ref("equipo_legal").on("value", s => {
    equipoLegalDinamico = s.exists() ? s.val() : { "1234": { nombre: "Dr. Charles Reyes", telefono: "584247640846" } };
});

document.getElementById('main-header').onclick = () => {
    if(++t === 5) {
        let clave = prompt("Ingrese PIN profesional:");
        if(equipoLegalDinamico[clave]) {
            esAdmin = true;
            nombreAdmin = equipoLegalDinamico[clave].nombre;
            telefonoAdmin = equipoLegalDinamico[clave].telefono;
            
            // Guardar en memoria del navegador para que no se pierda al refrescar
            localStorage.setItem('admin_activo', JSON.stringify(equipoLegalDinamico[clave]));
            
            document.getElementById('admin-panel').style.display='block';
            activarMotorAdmin(); 
            alert("Sesi√≥n iniciada: " + nombreAdmin);
        } else if(clave) { alert("PIN incorrecto."); }
        t = 0;
    }
};


// 6. L√ìGICA DE CONSULTA (CLIENTE)
// 6. L√ìGICA DE CONSULTA (CLIENTE)
function iniciarConsulta() {
    const nombre = document.getElementById('priv-nombre').value;
    const motivo = document.getElementById('priv-motivo').value;
    
    if(nombre && motivo) {
        consultaActualId = "CONSULTA_" + Date.now();
        const ref = db.ref("consultas_privadas/" + consultaActualId);
        
        // ELIMINADA LA INSTRUCCI√ìN onDisconnect().remove() PARA QUE PERMANEZCA
        
        ref.set({ cliente: nombre, motivo: motivo, timestamp: Date.now(), estado: "pendiente" });

        // GUARDAMOS EL ID EN EL CELULAR DEL FAMILIAR PARA QUE PUEDA REGRESAR LUEGO
        localStorage.setItem('mi_consulta_id', consultaActualId);

        // Si el abogado borra el caso, limpiamos la memoria y avisamos
        ref.on('value', snapshot => {
            if (!snapshot.exists()) {
                localStorage.removeItem('mi_consulta_id'); // Borramos el rastro
                alert("üîí LA SESI√ìN HA FINALIZADO: El chat y toda la informaci√≥n han sido destruidos por seguridad profesional.");
                location.reload(); 
            }
        });

        document.getElementById('registro-consulta').style.display = 'none';
        document.getElementById('interfaz-chat-privado').style.display = 'block';
        escucharMensajesPrivados();

        ref.on("value", s => {
            const data = s.val();
            if(data && data.abogadoNombre) {
                document.getElementById('titulo-abogado').innerHTML = `ü§ù Caso asignado a: <b>${data.abogadoNombre}</b>`;
                const btnWa = document.getElementById('btn-salto-wa');
                const msj = encodeURIComponent(`*CONSULTA PRIVADA*\nHola ${data.abogadoNombre}, soy ${data.cliente}. Caso: ${data.motivo}`);
                btnWa.href = `https://wa.me/${data.abogadoTelefono.replace(/\D/g,'')}?text=${msj}`;
                const btnVisual = btnWa.querySelector('button');
                btnVisual.innerText = `üü¢ CONTACTAR A ${data.abogadoNombre.toUpperCase()}`;
                btnVisual.style.background = "#25D366";
            }
        });
    } else { alert("Complete los datos."); }
}


// 7. MOTOR DE ALERTAS Y ATENCI√ìN (ADMIN)
// 7. MOTOR DE ALERTAS Y ATENCI√ìN (ADMIN)
function activarMotorAdmin() {
    console.log("Motor de alertas activado..."); 
    
    // Escuchamos los cambios en el nodo de consultas
    db.ref("consultas_privadas").on("value", snapshot => {
        // Si el usuario no es admin, no procesamos nada
        if (!esAdmin) return;
        
        const consultas = snapshot.val();
        const listaDiv = document.getElementById('lista-prioritaria');
        const panelAlerta = document.getElementById('panel-emergencias-admin');
        const seccionContenedora = document.getElementById('seccion-alertas');
        
        let pendientes = 0;

        // Si no hay ninguna consulta en la base de datos
        if (!consultas) {
            seccionContenedora.style.display = 'none';
            panelAlerta.style.display = 'none';
            listaDiv.innerHTML = "<p style='text-align:center;'>Bandeja vac√≠a</p>";
            alarmaAdmin.pause();
            return;
        }

        // Siempre mostramos la secci√≥n contenedora si llegamos aqu√≠
        seccionContenedora.style.display = 'block';
        
        // Bot√≥n de limpieza masiva al inicio de la lista
        listaDiv.innerHTML = `
            <button onclick="eliminarTodoSeguro()" style="width:100%; background:#333; color:white; border:none; padding:10px; border-radius:8px; margin-bottom:15px; font-weight:bold; cursor:pointer;">
                üóëÔ∏è ELIMINAR TODAS LAS CONSULTAS
            </button>`;

        // Recorremos las consultas para dibujar las tarjetas
        for (let id in consultas) {
            const c = consultas[id];
            
            // Filtramos solo las que est√°n en curso
            if (c.estado === "pendiente" || c.estado === "atendiendo") {
                if (c.estado === "pendiente") pendientes++;
                
                const colorFondo = c.estado === "atendiendo" ? "#e3f2fd" : "#fff";
                const textoBoton = c.estado === "atendiendo" ? "ABRIR CHAT" : "ATENDER";

                listaDiv.innerHTML += `
                    <div style="background:${colorFondo}; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <b>üë§ ${c.cliente}</b><br>
                            <small>‚öñÔ∏è ${c.motivo}</small>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button onclick="atenderConsulta('${id}')" style="background:#2e7d32; color:white; border:none; padding:8px; border-radius:5px; cursor:pointer;">
                                ${textoBoton}
                            </button>
                            <button onclick="borrarCasoSeguro('${id}')" style="background:#c62828; color:white; border:none; padding:8px; border-radius:5px; cursor:pointer;">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>`;
            }
        }

        // Actualizamos el contador visual
        document.getElementById('contador-pendientes').innerText = pendientes;

        // Si hay casos nuevos, mostramos el panel y activamos alarma
        if (pendientes > 0) {
            panelAlerta.style.display = 'block';
            alarmaAdmin.play().catch(e => console.log("Esperando interacci√≥n para audio"));
        } else {
            // Si hay casos pero todos est√°n siendo "atendidos", el panel sigue visible pero sin alarma
            panelAlerta.style.display = 'block';
            alarmaAdmin.pause();
            alarmaAdmin.currentTime = 0;
        }
    });
}


function atenderConsulta(id) {
    db.ref("consultas_privadas/" + id).update({
        estado: "atendiendo",
        abogadoNombre: nombreAdmin,
        abogadoTelefono: telefonoAdmin
    });
    
    consultaActualId = id;
    showView('view-chat-privado');
    document.getElementById('registro-consulta').style.display = 'none';
    document.getElementById('interfaz-chat-privado').style.display = 'block';
    escucharMensajesPrivados();
}


// 8. CHAT PRIVADO Y MULTIMEDIA
// 8. CHAT PRIVADO Y MULTIMEDIA
function escucharMensajesPrivados() {
    const box = document.getElementById('private-messages');
    if (listenerPrivado) listenerPrivado.off();

    const refConsulta = db.ref("consultas_privadas/" + consultaActualId);

    // DETECTOR DE CIERRE DE SESI√ìN SEGURO
    refConsulta.on('value', s => {
        if (!s.exists()) {
            localStorage.removeItem('mi_consulta_id'); // Borrar rastro si el admin lo elimin√≥
            alert("‚ö†Ô∏è SESI√ìN FINALIZADA: El abogado cerr√≥ el caso y la informaci√≥n fue eliminada del servidor por seguridad.");
            location.reload();
        }
    });

    listenerPrivado = refConsulta.child("mensajes");
    listenerPrivado.on("child_added", s => {
        const data = s.val();
        const emisorAdmin = data.emisor.includes("Dr") || data.emisor.includes("Abg");
        const esMio = (esAdmin && !emisorAdmin) || (!esAdmin && emisorAdmin);

        if (esMio) {
            new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3').play().catch(e=>0);
        }

        const bg = emisorAdmin ? "#d1f5d3" : "#f1f3f9";
        let contenido = data.tipo === 'audio' ? `<audio controls src="${data.contenido}"></audio>` : 
                        data.tipo === 'imagen' ? `<img src="${data.contenido}" style="max-width:100%">` : data.texto;

        box.innerHTML += `<div class="msg" style="background:${bg};"><b>${data.emisor}:</b><br>${contenido}</div>`;
        box.scrollTop = box.scrollHeight;
    });
}

// --- NUEVO SISTEMA: RECUPERAR CHAT AL VOLVER A ENTRAR A LA APP ---
setTimeout(() => {
    const miConsultaGuardada = localStorage.getItem('mi_consulta_id');
    if(miConsultaGuardada && !esAdmin) {
        db.ref("consultas_privadas/" + miConsultaGuardada).once("value").then(snapshot => {
            if(snapshot.exists()) {
                // Si el chat sigue existiendo en base de datos, lo metemos directo
                consultaActualId = miConsultaGuardada;
                showView('view-chat-privado');
                document.getElementById('registro-consulta').style.display = 'none';
                document.getElementById('interfaz-chat-privado').style.display = 'block';
                escucharMensajesPrivados();
            } else {
                // Si el administrador ya lo borr√≥ mientras el usuario estaba fuera
                localStorage.removeItem('mi_consulta_id');
            }
        });
    }
}, 1000);
// --- FIN DEL NUEVO SISTEMA ---



function enviarMensajeTextoPrivado() {
    const input = document.getElementById('priv-input');
    if(input.value.trim() && consultaActualId) {
        db.ref("consultas_privadas/" + consultaActualId + "/mensajes").push({
            emisor: esAdmin ? nombreAdmin : "Familiar",
            texto: input.value,
            tipo: 'texto',
            fecha: new Date().toLocaleTimeString()
        });
        input.value = "";
    }
}

async function toggleMicPrivado() {
    const btn = document.getElementById('btn-mic-privado');
    if (!grabando) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    db.ref("consultas_privadas/" + consultaActualId + "/mensajes").push({
                        emisor: esAdmin ? nombreAdmin : "Familiar",
                        tipo: "audio", contenido: e.target.result,
                        fecha: new Date().toLocaleTimeString()
                    });
                };
                reader.readAsDataURL(new Blob(audioChunks, { type: 'audio/webm' }));
            };
            mediaRecorder.start(); grabando = true;
            btn.innerHTML = "‚èπÔ∏è"; btn.style.background = "#ffcdd2";
        } catch (err) { alert("Micr√≥fono no accesible."); }
    } else { mediaRecorder.stop(); grabando = false; btn.innerHTML = "üé§"; btn.style.background = "#e0e0e0"; }
}

function procesarArchivoPrivado(event) {
    const file = event.target.files[0];
    if (!file || !consultaActualId) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        db.ref("consultas_privadas/" + consultaActualId + "/mensajes").push({
            emisor: esAdmin ? nombreAdmin : "Familiar",
            tipo: file.type.startsWith('image/') ? "imagen" : "archivo",
            contenido: e.target.result,
            nombreArchivo: file.name,
            fecha: new Date().toLocaleTimeString()
        });
    };
    reader.readAsDataURL(file);
}
// 9. FUNCIONES DE ACADEMIA, ORGANISMOS Y CHAT P√öBLICO (Tus funciones originales)
function filtrar() { 
    let val = document.getElementById('busqueda').value.toLowerCase(); 
    document.querySelectorAll('.card-juridica').forEach(c => c.style.display = c.innerText.toLowerCase().includes(val) ? "block" : "none"); 
}
function guardarProc() { 
    const t = document.getElementById('adm-proc-tit').value; 
    const txt = document.getElementById('adm-proc-txt').value; 
    if(t && txt) db.ref("proceso_penal").push({ titulo: t, texto: txt }).then(() => alert("Publicado")); 
}
function guardarOrg() { 
    const n = document.getElementById('adm-org-nom').value; 
    const i = document.getElementById('adm-org-tel').value; 
    if(n && i) db.ref("organismos").push({ nombre: n, info: i }).then(() => alert("Guardado")); 
}
function guardarAbogado() {
    const pin = document.getElementById('adm-abg-pin').value;
    const nom = document.getElementById('adm-abg-nom').value;
    const tel = document.getElementById('adm-abg-tel').value;
    if(pin && nom && tel) {
        db.ref("equipo_legal/" + pin).set({ nombre: nom, telefono: tel });
        alert("Colega registrado.");
    }
}
function enviarMensajePublico() {
    const msg = document.getElementById('chat-input').value;
    if(msg.trim()) { 
        db.ref("chat_publico").push({ user: esAdmin ? nombreAdmin : "Familiar", text: msg, timestamp: Date.now() }); 
        document.getElementById('chat-input').value = ""; 
    }
}

// Carga de datos iniciales
db.ref("chat_publico").limitToLast(15).on("child_added", s => {
    const data = s.val();
    const box = document.getElementById("public-messages");
    box.innerHTML += `<div class="msg"><b>${data.user}:</b> ${data.text}</div>`;
    box.scrollTop = box.scrollHeight;
});
// Funci√≥n para eliminar TODO el nodo de consultas privadas
function eliminarTodoSeguro() {
    if (confirm("üö® ¬øEST√Å SEGURO?\nEsta acci√≥n destruir√° ABSOLUTAMENTE TODAS las consultas, chats y archivos del servidor para garantizar la confidencialidad total.")) {
        db.ref("consultas_privadas").remove()
        .then(() => alert("Base de datos de consultas limpiada con √©xito."));
    }
}

// Funci√≥n para borrar un caso espec√≠fico
function borrarCasoSeguro(id) {
    db.ref("consultas_privadas/" + id).remove();
}

</script>
</body>
</html>
